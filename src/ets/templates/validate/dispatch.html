{% extends "base_template.html"%}
{% load i18n extra_tags %}

{% block title %}{% trans "Submit Dispatch to COMPAS" %}{% endblock %}

{% block content %}
<h3>{% block page_title %}{% trans "eWaybills Waiting For Dispatch Validation" %}{% endblock %}</h3>

<table cellpadding="0" cellspacing="0" border="0" class="display" id="toplist">
    <thead>
        <tr>
        <th>{% trans "LTI Number" %}</th>
        <th>{% trans "eWaybill Number" %}</th>
        <th>{% trans "Origin Warehouse" %}</th>
        <th>{% trans "Consignee" %}</th>
        <th>{% trans "Destination Location" %}</th>
        <th>{% trans "Dispatched" %}</th>
        <th>{% trans "Received" %}</th>
        <th>{% trans "Validate" %}</th>
        <th>{% trans "Errors" %}</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
{% comment %}
    {% for waybill in object_list %}
    {% with waybill.get_shortage_loading_details as shortage %}
    {% if shortage %}
    <tr class="error"><td colspan="8">
      {% for item in shortage %}
        <p>{{ waybill.order.warehouse }} --> {{ item.stock_item.coi_code }} ({{ item.stock_item.commodity }}). Shortage: {{ item.get_shortage }}</p>
      {% endfor %}
    </td></tr>
    {% endif %}
    {% endwith %}
    <tr>
       <td><a href="{{ waybill.order.get_absolute_url }}" title="View details">{{ waybill.order.pk }}</a></td>
       <td><a href="{{ waybill.get_absolute_url }}" title="View details">{{ waybill.pk }}</a></td>
       <td>{{ waybill.order.warehouse.name }}</td>
       <td>{{ waybill.order.consignee.name }}</td>
       <td>{{ waybill.order.location.name }}</td>
       <td>
        {% if waybill.transport_dispach_signed_date %}
          {{ waybill.transport_dispach_signed_date|date|upper }}
        {% else %}
          {% trans "Pending" %}
        {% endif %}
       </td>
       <td>
        {% if waybill.receipt_signed_date %}
          {{ waybill.receipt_signed_date|date|upper }}
        {% else %}
          {% trans "Pending" %}
        {% endif %}
       </td>
       <td>{% block validate_link %}{% validate_dispatch waybill user %}{% endblock %}</td>
    </tr>
      {% for log in waybill.compass_loggers.all|slice:"3" %}
        {% if log.action == logger_action %}
          <tr class="logger">
            <td>{{ log.when_attempted }}</td>
            <td>{{ log.compas }}</td>
            <td colspan="6">{{ log.message|linebreaks }}</td>
          </tr>
        {% endif %}
      {% endfor %}
    {% endfor %}
{% endcomment %}
</table>

<br/>
<h3>{% trans "Validated, but not yet sent to COMPAS" %}</h3>
<table cellpadding="0" cellspacing="0" border="0" class="display" id="validated_waybills">
    <thead>
      <tr>
        <th>{% trans "LTI Number" %}</th>
        <th>{% trans "eWaybill Number" %}</th>
        <th>{% trans "Origin Warehouse" %}</th>
        <th>{% trans "Consignee" %}</th>
        <th>{% trans "Destination Location" %}</th>
        <th>{% trans "Dispatched" %}</th>
        <th>{% trans "Received" %}</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
{% comment %}
    {% for waybill in validated_waybills %}
    <tr>
      <td><a href="{{ waybill.order.get_absolute_url }}" title="View details">{{ waybill.order.pk }}</a></td>
      <td><a href="{{ waybill.get_absolute_url }}" title="View details">{{ waybill.pk }}</a></td>
      <td>{{ waybill.order.warehouse.name }}</td>
      <td>{{ waybill.order.consignee.name }}</td>
      <td>{{ waybill.order.location.name }}</td>
      <td>
        {% if waybill.transport_dispach_signed_date %}
          {{ waybill.transport_dispach_signed_date|date|upper }}
        {% else %}
          {% trans "Pending" %}
        {% endif %}
      </td>
      <td>
        {% if waybill.receipt_signed_date %}
          {{ waybill.receipt_signed_date|date|upper }}
        {% else %}
          {% trans "Pending" %}
        {% endif %}
      </td>
    </tr>
    {% endfor %}
{% endcomment %}
</table>

{% block submit_form %}
<form method="POST" action="{% url send_dispatched %}" class="submit-form">{% csrf_token %}
	<input name="submit" value="{% trans 'Submit to COMPAS' %}" type="submit" />
</form>
{% endblock %}

<div id="error_list">
  <a class="close" href="#"></a>
  <div id="overlay_wrap"></div>
</div>
{% endblock %}

{% block script %}
{{ block.super }}
<script type="text/javascript">
$(document).ready(function() {
  var oTableBottom = $("#validated_waybills").dataTable({
      "bProcessing": true,
      "bServerSide": true,
      "sAjaxSource": "{% url table_validate_waybill filtering=bottom_table_url %}",
      "aoColumnDefs": [
          { "bSearchable": false, "bSortable": false, "bVisible": false, "aTargets": [ 7, 8 ] },
      ],
      "fnDrawCallback": function( oSettings ) {
          if (oSettings.aoData.length > 0) {
              $(".submit-form").show();
          } else {
              $(".submit-form").hide();
          };
      }
  });
  var oTableTop = $("#toplist").dataTable({
      "bProcessing": true,
      "bServerSide": true,
      "sAjaxSource": "{% url table_validate_waybill filtering=top_table_url %}",
      "aoColumnDefs": [
          { "bSearchable": false, "bSortable": false, "aTargets": [ 7, 8 ] },
      ],
      "fnRowCallback": function( nRow, aData, iDisplayIndex ) {
          if ( aData[8] != "" ) {
              nRow.className +=' red';
          };
          return nRow;
      },
      "fnDrawCallback": function( oSettings ) {
          $(".error-link").click(function(){
              var overlay = $("#error_list");
              var wrap = overlay.find("#overlay_wrap");
              wrap.empty();
              overlay.data("overlay").load();
              wrap.load($(this).attr("href"));
              overlay.find(".close").click(function() {
                  overlay.data("overlay").close();
                  return false;
              });
              return false;
          });
          $('.validate-link').click(function(){
              if (confirm('{% trans "Confirm validation?" %}')) {
                  data = {'csrfmiddlewaretoken': '{{ csrf_token }}'};
                  $.post($(this).attr("href"), data);
                  oTableTop.fnDraw();
                  oTableBottom.fnDraw();
              };
              return false;
          }); 
      }
  });
  $("#error_list").overlay({
      mask: {
          color: '#e2e3ee',
          loadSpeed: 200,
          opacity: 0.9
      },
  });
});
</script>
{% endblock %}
